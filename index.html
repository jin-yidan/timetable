<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable Widget</title>
    <meta name="color-scheme" content="light dark" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#050505" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <main class="shell" aria-label="Timetable widget">
      <header class="topbar">
        <div class="titleblock">
          <h1 id="pageTitle" class="title">Today</h1>
          <div class="header-controls">
            <nav class="view-nav">
              <button id="navTimeline" class="nav-btn active" type="button">Timeline</button>
              <button id="navTasks" class="nav-btn" type="button">Upcoming</button>
              <button id="navPlanner" class="nav-btn" type="button">Planner</button>
            </nav>
            <div class="topbar-actions" id="timelineActions">
              <button id="prevDayBtn" class="btn-icon-sm" type="button" title="Previous Day">←</button>
              <input id="dateInput" class="date" type="date" aria-label="Pick a day" />
              <button id="nextDayBtn" class="btn-icon-sm" type="button" title="Next Day">→</button>
              <a href="https://github.com/jin-yidan" target="_blank" class="github-link" title="My GitHub">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A3.37 3.37 0 0 0 22 4.01 3.37 3.37 0 0 0 21.48 1c-1.37 0-3.5 1.24-3.5 1.24a11.47 11.47 0 0 0-5.96 0S9.89 1 8.52 1a3.37 3.37 0 0 0-.52 3.01 3.37 3.37 0 0 0-.94 2.61c0 5.46 3.3 6.65 6.44 7a3.37 3.37 0 0 0-.94 2.61V22"></path></svg>
              </a>
            </div>
          </div>
        </div>
      </header>

      <section class="card" id="timelineView" aria-label="Timeline View">
        <div class="card-header">
          <span id="countHint" class="count-label">0 EVENTS</span>
          <button id="showAddBtn" class="btn-primary-sm" type="button">Add event</button>
        </div>

        <div class="progress-bar-wrap" id="progressBarWrap" hidden>
          <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>

        <form id="addForm" class="addrow-form" autocomplete="off" hidden>
          <div class="addrow-row-1">
            <input
              id="timeInput"
              class="input-minimal time-field"
              type="text"
              inputmode="numeric"
              placeholder="09:00"
              aria-label="Time"
              required
            />
            
            <input
              id="titleInput"
              class="input-minimal event-field"
              type="text"
              placeholder="What are you doing?"
              aria-label="Event"
              required
              maxlength="80"
              list="eventSuggestions"
            />
            <datalist id="eventSuggestions"></datalist>

            <button id="importantToggle" class="icon-toggle" type="button" title="Flag event">
              <span class="icon">⚐</span>
            </button>

            <button
              id="addBtn"
              class="btn-primary-sm"
              type="submit"
              disabled
              title="Add event"
            >
              Add
            </button>
          </div>

          <div class="addrow-row-2">
            <div class="time-chips">
              <button type="button" class="chip-sm" data-timechip="now">Now</button>
              <button type="button" class="chip-sm" data-timechip="+30">+30m</button>
              <button type="button" class="chip-sm" data-timechip="+60">+1h</button>
            </div>
            
            <div class="addrow-actions">
              <button id="toggleNoteBtn" class="btn-text-sm" type="button">Add note</button>
              <button id="cancelAddBtn" class="btn-text-sm" type="button">Cancel</button>
            </div>
          </div>

          <div id="noteWrap" class="note-field-wrap" hidden>
            <input
              id="noteInput"
              class="input-minimal note-field"
              type="text"
              placeholder="Add a footnote..."
              maxlength="140"
            />
          </div>
        </form>

        <div id="addFormDivider" class="divider" hidden></div>

        <div class="timeline-container">
          <ol id="timeline" class="timeline-list"></ol>
          
          <div id="emptyState" class="empty-view" hidden>
            <p id="emptyTitle">No events</p>
          </div>
        </div>
      </section>

      <!-- Tasks View (Upcoming) -->
      <section class="card" id="tasksView" aria-label="Upcoming Tasks" hidden>
        <div class="card-header">
          <span class="count-label" id="unfinishedCount">0 upcoming tasks</span>
        </div>
        <div class="divider"></div>
        <div class="tasks-container" id="unfinishedList">
          <!-- Grouped tasks will be injected here -->
        </div>
      </section>

      <!-- Planner View (Monthly) -->
      <section class="card" id="plannerView" aria-label="Monthly Planner" hidden>
        <div class="card-header">
          <span class="count-label">MONTHLY PLANNER</span>
          <button id="showPlannerAddBtn" class="btn-text-sm" type="button">Edit</button>
        </div>
        <div class="divider"></div>

        <!-- View Mode -->
        <div id="plannerDisplayContent" class="planner-container">
          <div id="monthlyPlannerList">
            <!-- Months and goals will be injected here -->
          </div>
        </div>

        <!-- Edit Mode -->
        <div id="plannerEditContent" class="planner-edit-container" hidden>
          <form id="plannerForm" class="planner-form-inline" autocomplete="off">
            <div class="planner-form-grid">
              <select id="plannerMonthInput" class="input-minimal" required>
                <option value="0">January</option>
                <option value="1">February</option>
                <option value="2">March</option>
                <option value="3">April</option>
                <option value="4">May</option>
                <option value="5">June</option>
                <option value="6">July</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">October</option>
                <option value="10">November</option>
                <option value="11">December</option>
              </select>
              <input id="plannerTitleInput" class="input-minimal" type="text" placeholder="Future goal..." required maxlength="80" />
              <button class="btn-primary-sm" type="submit">Add Goal</button>
            </div>
          </form>
          
          <div class="divider" style="margin: 20px 0;"></div>
          
          <div id="plannerEditList" class="planner-edit-list">
            <!-- Goals with remove buttons will be here -->
          </div>
        </div>
      </section>
    </main>

    <dialog id="editDialog" class="modal">
      <form id="editForm" class="modal-content" method="dialog">
        <header class="modal-header">
          <h2 class="modal-title">Edit Event</h2>
        </header>
        <div class="modal-body">
          <div class="edit-grid">
            <input class="input-minimal" id="editTimeInput" type="text" placeholder="Time" required />
            <input class="input-minimal" id="editTitleInput" type="text" placeholder="Event" required />
            <input class="input-minimal" id="editNoteInput" type="text" placeholder="Note" />
          </div>
        </div>
        <footer class="modal-footer">
          <button class="btn-text-sm danger" type="button" id="deleteEditBtn" style="margin-right: auto;">Delete</button>
          <button class="btn-text-sm" type="button" id="closeEditBtn">Cancel</button>
          <button class="btn-primary-sm" type="submit">Save</button>
        </footer>
      </form>
    </dialog>

    <template id="eventTemplate">
      <li class="timeline-item" data-id="">
        <div class="item-left">
          <div class="item-time" data-role="when"></div>
          <button class="check-circle" data-action="toggleDone" type="button" aria-label="Mark done"></button>
        </div>
        
        <div class="item-center">
          <div class="item-title" data-role="what"></div>
          <div class="item-note" data-role="note"></div>
        </div>

        <div class="item-right">
          <button class="icon-btn star-btn" data-action="toggleImportant" type="button" title="Flagged">
            <span class="icon" data-role="flag">⚐</span>
          </button>
          <button class="icon-btn" data-action="edit" title="More actions">⋯</button>
        </div>
      </li>
    </template>

    <script src="./app.js" defer></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then((reg) => {
            console.log('Service Worker registered.');
          }).catch((err) => {
            console.log('Service Worker registration failed:', err);
          });
        });
      }
    </script>
  </body>
</html>
