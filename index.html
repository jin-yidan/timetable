<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable Widget</title>
    <meta name="color-scheme" content="light dark" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#050505" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <main class="shell" aria-label="Timetable widget">
      <header class="topbar">
        <div class="titleblock">
          <div class="title-row">
            <h1 id="pageTitle" class="title">Today</h1>
            <button id="settingsBtn" class="btn-icon-sm settings-btn" type="button" title="Settings">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"></path>
              </svg>
            </button>
          </div>
          <div id="dateInfoLabel" class="date-info-label"></div>
          <nav class="view-nav">
            <button id="navTimeline" class="nav-btn active" type="button">Timeline</button>
            <button id="navWeek" class="nav-btn" type="button">Week</button>
            <button id="navTasks" class="nav-btn" type="button">Upcoming</button>
            <button id="navPlanner" class="nav-btn" type="button">Planner</button>
          </nav>
          <div class="topbar-actions" id="timelineActions">
            <button id="prevDayBtn" class="btn-icon-sm" type="button" title="Previous Day">←</button>
            <input id="dateInput" class="date" type="date" aria-label="Pick a day" />
            <button id="nextDayBtn" class="btn-icon-sm" type="button" title="Next Day">→</button>
          </div>
        </div>
      </header>

      <section class="card" id="timelineView" aria-label="Timeline View">
        <div class="card-header">
          <span id="countHint" class="count-label">0 EVENTS</span>
          <div class="header-actions">
            <button id="viewToggle" class="btn-icon-sm" type="button" title="Toggle view">☰</button>
            <button id="showAddBtn" class="btn-primary-sm" type="button">Add event</button>
          </div>
        </div>

        <div class="progress-bar-wrap" id="progressBarWrap" hidden>
          <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>

        <form id="addForm" class="addrow-form" autocomplete="off" hidden>
          <div class="addrow-row-1">
            <input
              id="timeInput"
              class="input-minimal time-field"
              type="text"
              inputmode="numeric"
              placeholder="09:00"
              aria-label="Start time"
              required
            />
            <span class="time-separator">-</span>
            <input
              id="endTimeInput"
              class="input-minimal time-field"
              type="text"
              inputmode="numeric"
              placeholder="10:00"
              aria-label="End time"
            />

            <input
              id="titleInput"
              class="input-minimal event-field"
              type="text"
              placeholder="Event title..."
              aria-label="Event"
              required
              maxlength="80"
              list="eventSuggestions"
            />
            <datalist id="eventSuggestions"></datalist>
          </div>

          <div id="nlpPreview" class="nlp-preview" hidden></div>

          <div class="addrow-row-2">
            <button id="toggleNoteBtn" class="btn-text-sm" type="button">Note</button>
            <input
              id="noteInput"
              class="input-minimal note-field-inline"
              type="text"
              placeholder="Add a note..."
              maxlength="140"
            />
          </div>

          <div class="addrow-row-3">
            <select id="recurrenceSelect" class="input-minimal select-sm">
              <option value="none">No repeat</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
            <button id="importantToggle" class="icon-toggle" type="button" title="Flag event">
              <span class="icon">⚐</span>
            </button>
            <div class="addrow-spacer"></div>
            <button id="cancelAddBtn" class="btn-text-sm" type="button">Cancel</button>
            <button id="addBtn" class="btn-primary-sm" type="submit" disabled title="Add event">Add</button>
          </div>
        </form>

        <div id="addFormDivider" class="divider" hidden></div>

        <div class="timeline-container">
          <ol id="timeline" class="timeline-list"></ol>
          <div id="timeBlockContainer" class="time-block-container" hidden></div>

          <div id="emptyState" class="empty-view" hidden>
            <p id="emptyTitle">No events</p>
          </div>
        </div>
      </section>

      <!-- Week View -->
      <section class="card" id="weekView" aria-label="Week View" hidden>
        <div class="card-header">
          <span class="count-label">WEEK VIEW</span>
          <div id="weekActions" class="week-actions">
            <button id="prevWeekBtn" class="btn-icon-sm" type="button" title="Previous Week">←</button>
            <span id="weekLabel" class="week-label">Jan 20 - Jan 26</span>
            <button id="nextWeekBtn" class="btn-icon-sm" type="button" title="Next Week">→</button>
            <button id="todayWeekBtn" class="btn-text-sm" type="button">Today</button>
          </div>
        </div>
        <div class="divider"></div>
        <div id="weekGrid" class="week-grid"></div>
      </section>

      <!-- Tasks View (Upcoming) -->
      <section class="card" id="tasksView" aria-label="Upcoming Tasks" hidden>
        <div class="card-header">
          <span class="count-label" id="unfinishedCount">0 upcoming tasks</span>
        </div>
        <div class="divider"></div>
        <div class="tasks-container" id="unfinishedList">
          <!-- Grouped tasks will be injected here -->
        </div>
      </section>

      <!-- Planner View (Monthly) -->
      <section class="card" id="plannerView" aria-label="Monthly Planner" hidden>
        <div class="card-header">
          <span class="count-label">MONTHLY PLANNER</span>
          <button id="showPlannerAddBtn" class="btn-text-sm" type="button">Edit</button>
        </div>
        <div class="divider"></div>

        <!-- View Mode -->
        <div id="plannerDisplayContent" class="planner-container">
          <div id="monthlyPlannerList">
            <!-- Months and goals will be injected here -->
          </div>
        </div>

        <!-- Edit Mode -->
        <div id="plannerEditContent" class="planner-edit-container" hidden>
          <form id="plannerForm" class="planner-form-inline" autocomplete="off">
            <div class="planner-form-grid">
              <select id="plannerMonthInput" class="input-minimal" required>
                <option value="0">January</option>
                <option value="1">February</option>
                <option value="2">March</option>
                <option value="3">April</option>
                <option value="4">May</option>
                <option value="5">June</option>
                <option value="6">July</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">October</option>
                <option value="10">November</option>
                <option value="11">December</option>
              </select>
              <input id="plannerTitleInput" class="input-minimal" type="text" placeholder="Future goal..." required maxlength="80" />
              <button class="btn-primary-sm" type="submit">Add Goal</button>
            </div>
          </form>
          
          <div class="divider" style="margin: 20px 0;"></div>
          
          <div id="plannerEditList" class="planner-edit-list">
            <!-- Goals with remove buttons will be here -->
          </div>
        </div>
      </section>
    </main>

    <dialog id="editDialog" class="modal">
      <form id="editForm" class="modal-content" method="dialog">
        <header class="modal-header">
          <h2 class="modal-title">Edit Event</h2>
        </header>
        <div class="modal-body">
          <div class="edit-grid">
            <input class="input-minimal" id="editDateInput" type="date" required />
            <div class="edit-time-row">
              <input class="input-minimal" id="editTimeInput" type="text" placeholder="Start" required />
              <span class="time-separator">-</span>
              <input class="input-minimal" id="editEndTimeInput" type="text" placeholder="End" />
            </div>
            <input class="input-minimal" id="editTitleInput" type="text" placeholder="Event" required />
            <input class="input-minimal" id="editNoteInput" type="text" placeholder="Note" />
            <select id="editRecurrenceSelect" class="input-minimal">
              <option value="none">No repeat</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
        </div>
        <footer class="modal-footer">
          <button class="btn-text-sm danger" type="button" id="deleteEditBtn" style="margin-right: auto;">Delete</button>
          <button class="btn-text-sm" type="button" id="closeEditBtn">Cancel</button>
          <button class="btn-primary-sm" type="submit">Save</button>
        </footer>
      </form>
    </dialog>

    <dialog id="settingsDialog" class="modal">
      <form id="settingsForm" class="modal-content" method="dialog">
        <header class="modal-header">
          <h2 class="modal-title">Settings</h2>
        </header>
        <div class="modal-body">
          <div class="settings-group">
            <label class="settings-label" for="calendarUrlInput">School Calendar URL (iCal)</label>
            <input class="input-minimal" id="calendarUrlInput" type="url" placeholder="https://..." />
            <p class="settings-hint">Enter your school's iCal calendar URL for auto-sync</p>
          </div>
          <div class="settings-status" id="syncStatus"></div>
        </div>
        <footer class="modal-footer">
          <button class="btn-text-sm" type="button" id="closeSettingsBtn">Cancel</button>
          <button class="btn-primary-sm" type="submit">Save</button>
        </footer>
      </form>
    </dialog>

    <template id="eventTemplate">
      <li class="timeline-item" data-id="">
        <div class="item-time" data-role="when"></div>

        <div class="item-center">
          <div class="item-title-row">
            <div class="item-title" data-role="what"></div>
            <div class="item-indicators" data-role="indicators"></div>
          </div>
          <div class="item-note" data-role="note"></div>
        </div>

        <div class="item-right">
          <button class="check-circle" data-action="toggleDone" type="button" aria-label="Mark done"></button>
          <button class="icon-btn" data-action="edit" title="More actions">⋯</button>
        </div>
      </li>
    </template>

    <script src="./holidays.js"></script>
    <script src="./app.js" defer></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then((reg) => {
            console.log('Service Worker registered.');
          }).catch((err) => {
            console.log('Service Worker registration failed:', err);
          });
        });
      }
    </script>
  </body>
</html>
